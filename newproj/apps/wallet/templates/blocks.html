{% extends "layout.html" %}
{% block content %}
<!-- Loading overlay -->
<div id="loader" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
  <div class="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
</div>

<div class="max-w-6xl mx-auto card p-6" x-data="blocksPage()" x-init="$nextTick(()=>document.getElementById('loader')?.classList.add('hidden'))">
  <h1 class="text-2xl font-extrabold text-yellow-400 mb-4">Blocks</h1>

  <div class="card p-4">
    <h2 class="text-yellow-400 text-xl font-bold mb-3">Search</h2>
    <div class="flex gap-2">
      <input class="flex-1 bg-black/30 px-3 py-2 rounded border border-yellow-700/40" placeholder="Block height / hash / txid" x-model="q"/>
      <button class="brand px-3 py-2 rounded" @click="doSearch()">Search</button>
    </div>
    <div class="text-xs text-gray-400 mt-2">Examples: 1003, a1b2c3..., full or prefix.</div>
    <div class="mt-2" x-show="searchError">
      <span class="text-red-400 text-sm" x-text="searchError"></span>
    </div>
    <div class="mt-2" x-show="result">
      <template x-if="result.type==='block'">
        <div class="text-sm">Block <a class="mono underline" :href="'/explorer/block/'+result.hash" x-text="result.title"></a></div>
      </template>
      <template x-if="result.type==='tx'">
        <div class="text-sm">Tx <a class="mono underline" :href="'/explorer/tx/'+result.id" x-text="result.id"></a></div>
      </template>
    </div>
  </div>

  <div class="card p-4 mt-4">
    <div class="flex items-center justify-between">
      <h2 class="text-yellow-400 text-xl font-bold mb-3">Latest Blocks</h2>
      <button class="brand px-3 py-1 rounded text-sm" @click="refresh()">Refresh</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="text-left text-sm text-gray-300">
            <th class="py-2 pr-4">Height</th>
            <th class="py-2 pr-4">Hash</th>
            <th class="py-2 pr-4">Time</th>
            <th class="py-2 pr-4">Miner</th>
            <th class="py-2 pr-4">Tx</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          <template x-for="b in blocks" :key="b.hash">
            <tr class="border-t border-yellow-900/30">
              <td class="py-2 pr-4" x-text="b.height"></td>
              <td class="py-2 pr-4 mono" x-text="b.hash.slice(0,24) + '...'"></td>
              <td class="py-2 pr-4" x-text="b.timestamp"></td>
              <td class="py-2 pr-4 mono" x-text="b.miner.slice(0,18) + '...'"></td>
              <td class="py-2 pr-4" x-text="b.tx_count"></td>
            </tr>
          </template>
          <tr x-show="blocks.length===0">
            <td class="py-3 text-gray-400" colspan="5">No blocks yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function blocksPage() {
  return {
    q: '',
    result: null,
    searchError: '',
    blocks: [],
    async init() {
      await this.refresh();
      setInterval(()=>this.refresh(), 10000);
    },
    async refresh() {
      try {
        const h = await fetch('/rpc/get_height').then(r=>r.json());
        const height = h.height ?? -1;
        const count = Math.min(25, height + 1);
        const rows = [];
        for (let i=0;i<count;i++){
          const hh = height - i;
          if (hh < 0) break;
          const hdr = await fetch('/rpc/get_header_by_height/' + hh).then(r=>r.json());
          rows.push({height: hdr.height, hash: hdr.hash, timestamp: hdr.timestamp, miner: hdr.miner, tx_count: hdr.tx_count});
        }
        this.blocks = rows;
      } catch(e) {
        this.blocks = [];
      }
    },
    async doSearch() {
      this.searchError = ''; this.result = null;
      const v = (this.q || '').trim();
      if (!v) return;
      try {
        if (/^\d+$/.test(v)) {
          const hh = parseInt(v, 10);
          const hdr = await fetch('/rpc/get_header_by_height/' + hh).then(r=>r.ok?r.json():null);
          if (hdr) {
            this.result = {type:'block', hash: hdr.hash, title: `${hdr.height} (${hdr.hash.slice(0,24)}...)`};
            return;
          }
        }
        // try block hash prefix
        // Wallet backend lacks a hash search API; we rely on explorer for deep search if needed.
        // For now, show a minimal hint:
        this.searchError = 'Direct hash/tx search not available in wallet. Use Explorer for full search.';
      } catch(e) {
        this.searchError = 'Search error';
      }
    }
  }
}
</script>
{% endblock %}
